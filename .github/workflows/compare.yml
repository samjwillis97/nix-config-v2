name: "Compare Nix Outputs"
on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true
jobs:
  linux-comparisons:
    if: github.event.action != 'closed'
    strategy:
      matrix:
        os: [ubuntu-latest]
        config:
          - mini-media-server
          - personal-desktop
    runs-on: ${{ matrix.os }}

    env:
      CONFIG: ${{ matrix.config }}

    steps:
      - uses: DeterminateSystems/nix-installer-action@main

      - name: Free Disk Space
        if: env.CONFIG == 'personal-desktop'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - uses: actions/checkout@v6

      - name: Build ${{ env.CONFIG }} for PR
        run: |
          nix build .#nixosConfigurations.${CONFIG}.config.system.build.toplevel
          mv result ../branch-result-${CONFIG}

      - uses: actions/checkout@v6
        with:
          ref: main

      - name: Build ${{ env.CONFIG }} main
        run: |
          nix build .#nixosConfigurations.${CONFIG}.config.system.build.toplevel
          mv result ../main-result-${CONFIG}

      - name: Compare builds (${{ env.CONFIG }})
        id: compare
        shell: bash
        run: |
          set -euo pipefail
          # Prefer nix run over nix-env -i
          nix run nixpkgs#nvd -- diff ../main-result-${CONFIG} ../branch-result-${CONFIG} | tee "nvd-${CONFIG}.diff"

          {
            echo 'diff<<EOF'
            cat "nvd-${CONFIG}.diff"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Update Pull Request (section for ${{ env.CONFIG }})
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const GLOBAL_MARKER = '<!-- nvd-diff-comment -->';
            const cfg = process.env.CONFIG;
            const SECTION_START = `<!-- nvd-section:${cfg} -->`;
            const SECTION_END   = `<!-- /nvd-section:${cfg} -->`;

            const diff = `${{ steps.compare.outputs.diff }}`.trim();

            const section = `
            ${SECTION_START}
            #### \`nvd diff\` on \`${cfg}\`
            <details><summary>Diff report</summary>

            \`\`\`text
            ${diff}
            \`\`\`

            </details>
            ${SECTION_END}
            `.trim();

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100
            });

            const existing = comments.find(c =>
              c.body?.includes(GLOBAL_MARKER) &&
              (c.user?.type === 'Bot' || c.user?.login === context.actor)
            );

            if (existing) {
              let body = existing.body;

              const startIdx = body.indexOf(SECTION_START);
              const endIdx   = body.indexOf(SECTION_END);

              if (startIdx !== -1 && endIdx !== -1) {
                const before = body.slice(0, startIdx);
                const after  = body.slice(endIdx + SECTION_END.length);
                body = `${before}${section}\n\n${after}`.trim();
              } else {
                body = `${body.trim()}\n\n${section}`;
              }

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              const header = `
              ${GLOBAL_MARKER}
              ## Nix build diffs
              `.trim();

              const body = `${header}\n\n${section}`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  darwin-comparisons:
    if: github.event.action != 'closed'
    strategy:
      matrix:
        os: [macos-latest]
        config:
          - Sams-MacBook-Air
          - work-mbp
    runs-on: ${{ matrix.os }}

    env:
      CONFIG: ${{ matrix.config }}

    steps:
      - uses: DeterminateSystems/nix-installer-action@main

      - uses: actions/checkout@v6

      - name: Build ${{ env.CONFIG }} for PR
        run: |
          nix build .#darwinConfigurations.${CONFIG}.config.system.build.toplevel
          mv result ../branch-result-${CONFIG}

      - uses: actions/checkout@v6
        with:
          ref: main

      - name: Build ${{ env.CONFIG }} main
        run: |
          nix build .#darwinConfigurations.${CONFIG}.config.system.build.toplevel
          mv result ../main-result-${CONFIG}

      - name: Compare builds (${{ env.CONFIG }})
        id: compare
        shell: bash
        run: |
          set -euo pipefail
          # Prefer nix run over nix-env -i
          nix run nixpkgs#nvd -- diff ../main-result-${CONFIG} ../branch-result-${CONFIG} | tee "nvd-${CONFIG}.diff"

          {
            echo 'diff<<EOF'
            cat "nvd-${CONFIG}.diff"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Update Pull Request (section for ${{ env.CONFIG }})
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const GLOBAL_MARKER = '<!-- nvd-diff-comment -->';
            const cfg = process.env.CONFIG;
            const SECTION_START = `<!-- nvd-section:${cfg} -->`;
            const SECTION_END   = `<!-- /nvd-section:${cfg} -->`;

            const diff = `${{ steps.compare.outputs.diff }}`.trim();

            const section = `
            ${SECTION_START}
            #### \`nvd diff\` on \`${cfg}\`
            <details><summary>Diff report</summary>

            \`\`\`text
            ${diff}
            \`\`\`

            </details>
            ${SECTION_END}
            `.trim();

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100
            });

            const existing = comments.find(c =>
              c.body?.includes(GLOBAL_MARKER) &&
              (c.user?.type === 'Bot' || c.user?.login === context.actor)
            );

            if (existing) {
              let body = existing.body;

              const startIdx = body.indexOf(SECTION_START);
              const endIdx   = body.indexOf(SECTION_END);

              if (startIdx !== -1 && endIdx !== -1) {
                const before = body.slice(0, startIdx);
                const after  = body.slice(endIdx + SECTION_END.length);
                body = `${before}${section}\n\n${after}`.trim();
              } else {
                body = `${body.trim()}\n\n${section}`;
              }

              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              const header = `
              ${GLOBAL_MARKER}
              ## Nix build diffs
              `.trim();

              const body = `${header}\n\n${section}`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
