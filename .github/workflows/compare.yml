name: "Compare"
on:
  pull_request:
jobs:
  comparisons:
    runs-on: ubuntu-latest
    steps:
    - uses: cachix/install-nix-action@v31
      with:
        nix_path: nixpkgs=channel:nixos-unstable
    - uses: actions/checkout@v5

    - name: Build mini-media-server for PR
      run: |
        nix build .#nixosConfigurations.mini-media-server.config.system.build.toplevel
        mv result ../branch-result

    - uses: actions/checkout@v5
      with:
        ref: "main"
    - name: Build mini-media-server main
      run: |
        nix build .#nixosConfigurations.mini-media-server.config.system.build.toplevel
        mv result ../main-result
    - name: Compare builds
      id: compare
      run: |
        nix-env -i nvd -f '<nixpkgs>' >/dev/null 2>&1
        nvd diff ../main-result ../branch-result

    - name: Update Pull Request
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const output = `
          <details><summary>Show Plan</summary>
 
          \`\`\`\n
          ${{ steps.compare.outputs.stdout }}
          \`\`\`
 
          </details>
 
          *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
 
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })
